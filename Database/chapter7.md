# 第七章 数据库恢复技术
## 7.1 事物的基本概念
### 一、什么是事物
事物(Transaction)是用户定义的一个数据库操作序列,这些操作要么全做,要么不做,是一个不可分割的工作单位  
事物和程序是两个概念
- 在关系数据库中一个事物可以是一个SQL语句,一组SQL语句或者整个程序
- 一个应用程序通常包含多个实物

事物是回复和并发控制的基本概念

### 二、如何定义事物
显式定义方式  
begin transaction...commit  
隐式定义方式  
当用户没有显示地定义事物时,DBMS按缺省规定自动划分事物  
事物结束:  
COMMIT  
- 事物正常结束
- 提交事物的所有操作
- 失误中所有对数据库的更新永久生效

ROLLBACK  
- 事物异常终止
- 食物运行的过程发生了故障,不能继续执行回滚事务的所有更新操作
- 事物滚回到开始时的状态

### 三、事物的特性(ACID特性)
事物的ACID特性:
- 原子性(Atomicity)
- 一致性(Consistency)
- 隔离性(Isolation)
- 持续性(Durability)

#### 1.原子性
事物是数据库的逻辑工作单位
- 事物中包括的诸操作要么都做,要么都不做

#### 2.一致性
事物执行的结果必须是使数据库从一个一致性状态变到另一个一致性状态  
一致性状态:  
数据库中质保函成功事物提交的结果  
不一致性状态:  
数据库包含失败事物的结果

#### 3.隔离性
对并发执行,一个事物的执行不能被其他事物干扰
- 一个事物内部的错做及使用的数据对其他并发事物是隔离的
- 并发执行的各个事物之间不能相互干扰

#### 4.持续性
也称持久性
- 指一个事物一旦提交,它对数据库中数据的改变就应该是永久性的。
- 接下来的其他操作或故障不应该对其执行结果有任何影响。

#### 事物的特性
- 保证事物ACID特性是事物处理的任务
- 破坏实物ACID特性的因素:
    - 多个实物并行运行时,不同事物的操作交叉执行
    - 失误在运行过程中被强行停止

## 7.2 数据库恢复概述
- 故障时不可避免的
    - 计算机硬件故障
    - 系统软件和应用软件的错误
    - 操作员的失误
    - 恶意的破坏
- 故障的影响
    - 运行事物非正常中断
    - 破坏数据库
- 数据库管理系统对故障的对策
    - DBMS提供恢复子系统
    - 保障故障发生后,能把数据库中的数据从错误状态恢复到某种逻辑一致的状态
    - 保证事物ACID
- 恢复技术是衡量系统优劣的重要指标

## 7.3 故障的种类
### 一、事务故障
- 什么是事务故障
    - 某个事物在运行过程中由于种种原因未运行至正常终止点就夭折了
- 事物故障的常见原因
    - 输入数据有误
    - 运算溢出
    - 违反了某些完整性限制
    - 某些应用程序出错
    - 并行事物发生死锁
    - ...
- 事物故障的恢复
    - 发生事物故障时,夭折的事物可能已经把数据库的部分修改写回磁盘
    - 事物故障的恢复:撤销事物(UNDO)
    - 强行回滚(ROLLBACK)该事物
    - 清除该事物对数据库的所有修改,使得这个事物像根本没有启动过一样

### 二、系统故障
- 什么是系统故障
    - 整个系统的正常运行突然被破坏
    - 所有正在运行的事物都非正常终止
    - 内存中数据库缓冲区的信息全部丢失
    - 外部存储设备上的数据未受影响
- 导致系统故障的常见原因
    - 操作系统或DBMS代码错误
    - 操作员操作失误
    - 特点类型的硬件错误(如CPU故障)
    - 突然停电
- 系统故障的恢复
    - 清除尚未完成的事物对数据库的所有修改
        - 系统重新启动时,回复程序要强行撤销(UNDO)所有未完成事物
    - 将缓冲区中已经完成事物提交的结果写入数据库
        - 系统重新启动时,恢复程序需要重做(REDO)所有已经提交的事物

### 三、介质故障
- 硬件故障使存储在外村中的数据部分丢失或全部丢失
- 介质故障比前两类故障的可能性小得多,但破坏性大得多
- 介质故障的恢复
    - 装入数据库发生截止故障前某个时刻的数据副本
    - 重做自此时始的所有成功事物,讲这些事物已提交的结果重新记入数据库

## 7.4、恢复操作的基本原理
- 恢复操作的基本原来:冗余
    - 利用存储在系统其他地方的冗余数据来重建数据库中已经被破坏或者不正确的那部分数据
- 恢复的实现技术:复杂
    - 一个大型数据库产品,恢复子系统的代码要占全部代码的10%以上

建立冗余数据最常用的办法是数据转储和登记日志文件(logging)
### 一、什么是转储
- 转储是这DBA将整个数据库复制到磁带或另一个磁盘上保存起来的过程
- 这些备用的数据文本成为后备副本或后援副本
1. 静态转储: 

    ```        
    在系统中无运行事物时进行转储
    转储开始时数据库处于一致性状态
    转储期间不允许对数据库的任何存取、修改活动
    优点:实现简单
    缺点:降低了数据库的可用性
        转储必须等用户事物结束
        新的事物必须等转储结束
    ```

2. 海量转储与增量转储
- 海量转储:每次转储全部数据库
- 增量转储:只转储上次转储后更新过的数据
- 海量和增量转储比较:
    - 从回复角度看,使用海量转储得到的后备副本进行回复往往更方便
    - 但如果数据库很大,事物处理又十分频繁,则增量转储方式更实用更有效
3. 转储方法小结
- 转储方法分类

    <table>
        <tr>
            <td rowspan="2" colspan="2"></td>
            <td colspan="2">转储状态</td>
        </tr>
        <tr>
            <td>动态转储</td>
            <td>静态转储</td>
        </tr>
        <tr>
            <td rowspan="2">转储方式</td>
            <td>海量转储</td>
            <td>动态海量转储</td>
            <td>静态海量转储</td>
        </tr>        
        <tr>
            <td>增量转储</td>
            <td>动态增量转储</td>
            <td>静态增量转储</td>
        </tr>
    </table>

#### 转储策略
- 应定期进行数据转储,制作后备副本
- 但转储又是十分耗费时间和资源的,不能频繁进行
- DBA要你管管根据数据库使用情况确定适当的转储周期和转储方法  
    例:
    - 每天晚上进行动态增量转储
    - 每周进行一次动态海量转储
    - 每月进行一次静态海量转储
