# 第七章 数据库恢复技术
## 7.1 事物的基本概念
### 一、什么是事物
事物(Transaction)是用户定义的一个数据库操作序列,这些操作要么全做,要么不做,是一个不可分割的工作单位  
事物和程序是两个概念
- 在关系数据库中一个事物可以是一个SQL语句,一组SQL语句或者整个程序
- 一个应用程序通常包含多个实物

事物是回复和并发控制的基本概念

### 二、如何定义事物
显式定义方式  
begin transaction...commit  
隐式定义方式  
当用户没有显示地定义事物时,DBMS按缺省规定自动划分事物  
事物结束:  
COMMIT  
- 事物正常结束
- 提交事物的所有操作
- 失误中所有对数据库的更新永久生效

ROLLBACK  
- 事物异常终止
- 食物运行的过程发生了故障,不能继续执行回滚事务的所有更新操作
- 事物滚回到开始时的状态

### 三、事物的特性(ACID特性)
事物的ACID特性:
- 原子性(Atomicity)
- 一致性(Consistency)
- 隔离性(Isolation)
- 持续性(Durability)

#### 1.原子性
事物是数据库的逻辑工作单位
- 事物中包括的诸操作要么都做,要么都不做

#### 2.一致性
事物执行的结果必须是使数据库从一个一致性状态变到另一个一致性状态  
一致性状态:  
数据库中质保函成功事物提交的结果  
不一致性状态:  
数据库包含失败事物的结果

#### 3.隔离性
对并发执行,一个事物的执行不能被其他事物干扰
- 一个事物内部的错做及使用的数据对其他并发事物是隔离的
- 并发执行的各个事物之间不能相互干扰

#### 4.持续性
也称持久性
- 指一个事物一旦提交,它对数据库中数据的改变就应该是永久性的。
- 接下来的其他操作或故障不应该对其执行结果有任何影响。

#### 事物的特性
- 保证事物ACID特性是事物处理的任务
- 破坏实物ACID特性的因素:
    - 多个实物并行运行时,不同事物的操作交叉执行
    - 失误在运行过程中被强行停止

## 7.2 数据库恢复概述
- 故障时不可避免的
    - 计算机硬件故障
    - 系统软件和应用软件的错误
    - 操作员的失误
    - 恶意的破坏
- 故障的影响
    - 运行事物非正常中断
    - 破坏数据库
- 数据库管理系统对故障的对策
    - DBMS提供恢复子系统
    - 保障故障发生后,能把数据库中的数据从错误状态恢复到某种逻辑一致的状态
    - 保证事物ACID
- 恢复技术是衡量系统优劣的重要指标

## 7.3 故障的种类
### 一、事务故障
- 什么是事务故障
    - 某个事物在运行过程中由于种种原因未运行至正常终止点就夭折了
- 事物故障的常见原因
    - 输入数据有误
    - 运算溢出
    - 违反了某些完整性限制
    - 某些应用程序出错
    - 并行事物发生死锁
    - ...
- 事物故障的恢复
    - 发生事物故障时,夭折的事物可能已经把数据库的部分修改写回磁盘
    - 事物故障的恢复:撤销事物(UNDO)
    - 强行回滚(ROLLBACK)该事物
    - 清除该事物对数据库的所有修改,使得这个事物像根本没有启动过一样

### 二、系统故障
- 什么是系统故障
    - 整个系统的正常运行突然被破坏
    - 所有正在运行的事物都非正常终止
    - 内存中数据库缓冲区的信息全部丢失
    - 外部存储设备上的数据未受影响
- 导致系统故障的常见原因
    - 操作系统或DBMS代码错误
    - 操作员操作失误
    - 特点类型的硬件错误(如CPU故障)
    - 突然停电
- 系统故障的恢复
    - 清除尚未完成的事物对数据库的所有修改
        - 系统重新启动时,回复程序要强行撤销(UNDO)所有未完成事物
    - 将缓冲区中已经完成事物提交的结果写入数据库
        - 系统重新启动时,恢复程序需要重做(REDO)所有已经提交的事物

### 三、介质故障
- 硬件故障使存储在外村中的数据部分丢失或全部丢失
- 介质故障比前两类故障的可能性小得多,但破坏性大得多
- 介质故障的恢复
    - 装入数据库发生截止故障前某个时刻的数据副本
    - 重做自此时始的所有成功事物,讲这些事物已提交的结果重新记入数据库

## 7.4、恢复操作的基本原理
- 恢复操作的基本原来:冗余
    - 利用存储在系统其他地方的冗余数据来重建数据库中已经被破坏或者不正确的那部分数据
- 恢复的实现技术:复杂
    - 一个大型数据库产品,恢复子系统的代码要占全部代码的10%以上

建立冗余数据最常用的办法是数据转储和登记日志文件(logging)
### 一、什么是转储 (用于介质故障)
- 转储是这DBA将整个数据库复制到磁带或另一个磁盘上保存起来的过程
- 这些备用的数据文本成为后备副本或后援副本
1. 静态转储: 

    ```        
    在系统中无运行事物时进行转储
    转储开始时数据库处于一致性状态
    转储期间不允许对数据库的任何存取、修改活动
    优点:实现简单
    缺点:降低了数据库的可用性
        转储必须等用户事物结束
        新的事物必须等转储结束
    ```

2. 海量转储与增量转储
- 海量转储:每次转储全部数据库
- 增量转储:只转储上次转储后更新过的数据
- 海量和增量转储比较:
    - 从回复角度看,使用海量转储得到的后备副本进行回复往往更方便
    - 但如果数据库很大,事物处理又十分频繁,则增量转储方式更实用更有效
3. 转储方法小结
- 转储方法分类

    <table>
        <tr>
            <td rowspan="2" colspan="2"></td>
            <td colspan="2" align="center">转储状态</td>
        </tr>
        <tr>
            <td>动态转储</td>
            <td>静态转储</td>
        </tr>
        <tr>
            <td rowspan="2" align="center">转储方式</td>
            <td>海量转储</td>
            <td>动态海量转储</td>
            <td>静态海量转储</td>
        </tr>        
        <tr>
            <td>增量转储</td>
            <td>动态增量转储</td>
            <td>静态增量转储</td>
        </tr>
    </table>

#### 转储策略
- 应定期进行数据转储,制作后备副本
- 但转储又是十分耗费时间和资源的,不能频繁进行
- DBA要你管管根据数据库使用情况确定适当的转储周期和转储方法  
    例:
    - 每天晚上进行动态增量转储
    - 每周进行一次动态海量转储
    - 每月进行一次静态海量转储

### 二、登记日志文件
#### 1.什么是日志文件
日志文件(log)是用来记录事物对数据库的更新(增删改)操作的文件。是一个流水账
#### 2.日志文件的格式
- 以记录为单位的日志
- 以数据块为单位的日志

#### 3.日志文件的内容
- 各个事物的开始标志
- 各个事物的结束标志
- 各个事物的所有更新操作
- 与实物有关的内部更新操作

日志文件中的一个日志记录(log record)  
#### 4.基于记录的日志文件
每条日志记录的内容  
- 事物标识
- 操作类型(插入,删除或修改)
- 操作对象(记录ID,Block NO.)
- 更新前数据的旧值
- 更新后数据的新值

#### 5.基于数据块的日志文件
与基于记录基本相似,删除记录

### 三、日志文件的用途
#### 1.用途
- 进行事物故障恢复
- 进行系统故障恢复
- 协助后备副本进行介质故障恢复

### 四、登记日志文件的原则
- 为保证数据库是可恢复的,登记日志文件时必须遵循两条原则
    - 登记的次序严格按并行事物执行的时间
    - 必须先写日志文件,后写数据库
        - 写日志文件操作:表示这个修改的日志记录写到日志文件
        - 写数据库操作:把对数据的修改写到数据库中
- 为什么要先写日志文件
    - 写数据库和写日志文件是两个不同的操作
    - 在两个操作之间可能发生故障
    - 如果先写数据库,而日志没有登记,则以后无法恢复这个修改
    - 如果先写日志,但没有修改数据库,按日志恢复时只不过是多执行一次不必要的UNDO操作,并不影响数据库的正确性

## 7.5 恢复策略
### 一、事务故障的恢复
- 事物故障:事物在运行至正常终止点前被中止
- 恢复方法
    - 由恢复子系统应利用日志文件撤销(UNDO)次失误一堆数据库进行的修改
- 事物故障的恢复由系统自动完成,不需要用户干预

### 二、系统故障的恢复
- 系统故障造成数据库不一致状态的原因
    - 一些未完成事物对数据库的更新已写入数据库
    - 一些已提交事物对数据库的更新还留在缓冲区没来得及写入数据库
- 恢复方法
    - UNDO故障发生时未完成的事物
    - REDO已完成的事物
- 系统故障的恢复由系统在重新启动时自动完成,不需要用户干预

### 三、介质故障的恢复
1.重装数据库,使数据库恢复到一致性状态  
2.重做已完成的事物  
介质故障的恢复需要DBA的介入
- DBA的工作
    - 重装最近转储的数据库副本和有关的各日志文本副本
    - 执行系统提供的恢复命令
- 具体的恢复操作仍由DBMS完成

## 7.6 具有检查点的回复技术
### 一、问题的提出
搜索整个日志将耗费大量的时间  
REDO处理:重新执行,流浪废了大量的时间
### 二、检查点技术
- 检查点记录的内容
    - 检录检查点时刻所有正在执行的事物清单
    - 这些事物最近一个日志记录的地址
- 重新开始文件的内容
    - 记录各个检查点记录在日志文件中的地址

#### 在检查点维护日志文件  
1. 将当前日志缓冲区中的所有日志记录写入磁盘的日志文件上
2. 在日志文件中写入一个检查点记录
3. 将当前数据缓冲区的所有数据记录写入磁盘的数据库中
4. 把检查点记录的地址写入重新开始文件

#### 建立检查点
- 定期
    - 按照预定的一个时间间隔
- 不定期
    - 按照某种规则,如日志文件已经写满一半建立一个检查点

### 三 、利用检查点的恢复策略
- 当时无T在一个检查点之前提交  
    T对数据库所做的修改已写入数据库
- 在进行恢复处理时,没必要对事物T执行REDO操作

#### 步骤
1. 从重新开始文件中找到最后一个检查点记录在日志文件中的地址
2. 由该地址在日志文件中找到最后一个检查点记录
